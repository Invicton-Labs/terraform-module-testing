name: 'Terraform Module Testing Matrix'
description: 'Generates a Terraform module testing matrix for use with GitHub Actions.'

inputs:
  minimum_tf_version:
    description: "The minimum version of Terraform to test with."
    required: true

outputs:

  strategy: 
    description: "The JSON-encoded strategy to use for the testing jobs."
    value: ${{ steps.matrix.outputs.matrix }}

runs:
  using: 'composite'

  steps:

    # Get the list of Linux images that we want to test on
    - name: Get Images
      id: images
      shell: bash
      run: echo ::set-output name=images::'["alpine:latest", "redhat/ubi9:latest", "fedora:latest", "centos:latest", "ubuntu:latest", "amazonlinux:1", "amazonlinux:2"]'

    # Get the list of Windows operating systems to test on
    - name: Get Windows Operating Systems
      id: windows
      shell: bash
      run: echo ::set-output name=names::'["windows-2022", "windows-2019", "windows-2016"]'

    # Get the list of MacOS operating systems to test on
    - name: Get MacOS Operating Systems
      id: macos
      shell: bash
      run: echo ::set-output name=names::'["mac-12", "mac-11", "mac-10.15"]'

    # Merge the Windows and MacOS operating system lists together
    - name: Get Non-Linux Operating Systems
      id: non-linux
      shell: bash
      run: echo ::set-output name=names::$(jq --argjson windows '${{ steps.windows.outputs.names }}' --argjson macos '${{ steps.macos.outputs.names }}' -n '$windows + $macos' )

    # Get the full list of Terraform versions.
    # For each major/minor version, only get the first release (no subsequent patch versions)
    - name: Get Terraform Versions
      id: terraform
      shell: bash
      run: |
        set -eu -o pipefail

        lowest_version="${{ inputs.minimum_tf_version }}"
        lowest_major=$(echo $lowest_version | cut -d. -f1)
        lowest_minor=$(echo $lowest_version | cut -d. -f2)
        lowest_patch=$(echo $lowest_version | cut -d. -f3)

        versions_html=$(curl -s https://releases.hashicorp.com/terraform/ 2>&1)
        version_lines=$(echo "$versions_html" | grep -oE "terraform/[0-9]+\.[0-9]+\.[0-9]+/")

        selected_versions=""

        while read -r version ; do
            major=$(echo $version | cut -d. -f1)
            minor=$(echo $version | cut -d. -f2)
            patch=$(echo $version | cut -d. -f3)
            if [ $major -gt $lowest_major ] || ( [ $major -eq $lowest_major ] && [ $minor -gt $lowest_minor ] ) || ( [ $major -eq $lowest_major ] && [ $minor -eq $lowest_minor ] && [ $patch -ge $lowest_patch ] ); then
                if [ $patch -eq 0 ] || [ $version = $lowest_version ]; then
                    if [ -z $selected_versions ]; then
                        selected_versions="$version"
                    else
                        selected_versions="$selected_versions,$version"
                    fi
                fi
            fi
        done <<<$(echo "$version_lines" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+")

        echo ::set-output name=versions::$(jq -n --arg inarr "${selected_versions}" '$inarr | split(",")')

    # Generate excluded container configurations.
    # amazonlinux doesn't support anything below TF v0.13.x
    - name: Generate Matrix
      id: matrix
      shell: bash
      run: |
        set -eu -o pipefail

        windows_versions='${{ steps.windows.outputs.names }}'
        macos_versions='${{ steps.mac.outputs.names }}'
        images='${{ steps.images.outputs.images }}'
        tf_versions='${{ steps.terraform.outputs.versions }}'

        matrix=()

        # Start with the Linux containers
        for image in $(echo "${images}" | jq -r '.[]'); do
          for version in $(echo "${tf_versions}" | jq -r '.[]'); do
            major=$(echo $version | cut -d. -f1)
            minor=$(echo $version | cut -d. -f2)
            # Exclude Amazon Linux 1/2 with any version less than 13
            #if ! ( [ $major -eq 0 ] && [ $minor -lt 13 ] && ( [ "$image" = "amazonlinux:1" ] || [ "$image" = "amazonlinux:2" ] )) then
              
              # matrix+=("{\"container\": \"{\\\"image\\\": \\\"$image\\\"}, \"terraform_version\": \"$version\", \"runs-on\": \"ubuntu-latest\"}")
            #fi
          done
        done

        # Add the Linux shell configurations
        for version in $(echo "${tf_versions}" | jq -r '.[]'); do
          matrix+=("{\"terraform_version\": \"$version\", \"runs-on\": \"ubuntu-latest\", \"shells\": \"true\", \"container\": \"{}\"}")
        done

        # Add the non-Linux configurations
        for os in $(echo "${windows_versions}" | jq -r '.[]'); do
          for version in $(echo "${tf_versions}" | jq -r '.[]'); do
            matrix+=("{\"runs-on\": \"$os\", \"terraform_version\": \"$version\", \"container\": \"{}\"}")
          done
        done
        for os in $(echo "${macos_versions}" | jq -r '.[]'); do
          for version in $(echo "${tf_versions}" | jq -r '.[]'); do
            matrix+=("{\"runs-on\": \"$os\", \"terraform_version\": \"$version\", \"container\": \"{}\"}")
          done
        done

        _matrix=$(echo "${matrix[@]}" | jq -rs '.' )
        echo ::set-output name=matrix::$(jq -n --argjson matrix "$_matrix" '{"fail-fast": false, "matrix": {"include": $matrix}}')
